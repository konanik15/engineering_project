<!DOCTYPE html>
<html>
  <head>
    <title>Lobby</title>
    <style>
      #main {
        width: 200px;
      }
      h1 {
        margin: 0;
        display: inline-block;
      }
      
    </style>
  </head>
  <body>
    <div id="main">
      <h1>Lobby</h1>
      <button id="start" disabled="true">Start</button>
    </div>
    <button id="ready">Ready</button>
    <button id="unready">Unready</button>

    <div id="players">
      <h2>Players:</h2>
      <ul id="playerList"></ul>
    </div>
    <label for="games">Choose the game:</label>
      <select name="games" id="games">
        <option value="wojna">Wojna</option>
        <option value="makao">Makao</option>
        <option value="duren">Duren</option>
        <option value="poker">Poker</option>
      </select>
    <div id="chat">
      <h2>Chat:</h2>
      <ul id="chatMessages"></ul>
      <form id="chatForm">
        <input
          type="text"
          id="messageInput"
          placeholder="Enter a message"
          required
        />
        <button type="submit">Send</button>
      </form>
    </div>
    <div id="lobbyId" style="display: none"></div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      const socket = io();

      function updatePlayerList(players) {
        const playerList = document.getElementById("playerList");
        playerList.innerHTML = "";

        players.forEach((player) => {
          const li = document.createElement("li");
          
          isReadyText = player.ready ? "ready" : "not ready";
          isLeader = player.leader ? "[leader]" : "";
          li.textContent =
            isLeader + " " + player.socketId + ": " + isReadyText;
          playerList.appendChild(li);
          if (!player.leader) {
            const kickButton = document.createElement("button");
            kickButton.innerText = 'kick';
            playerList.appendChild(kickButton);
          }
        });
      }

      function handleGameChange(event) {
        event.preventDefault();
        const lobbyGameValue = document.getElementById('games');
        const game = lobbyGameValue.value;
        const lobbyId = document.getElementById("lobbyId").textContent;
        socket.emit('gameChanged', { game, lobbyId });
      }

      function updateChatMessages(messages) {
        const chatMessages = document.getElementById("chatMessages");
        chatMessages.innerHTML = "";
        messages.forEach((message) => {
          const li = document.createElement("li");
          li.textContent = `${message.sender}: ${message.message}`;
          chatMessages.appendChild(li);
        });
      }

      function handleChatFormSubmit(event) {
        event.preventDefault();
        const messageInput = document.getElementById("messageInput");
        const message = messageInput.value;
        messageInput.value = "";

        const lobbyId = document.getElementById("lobbyId").textContent;

        socket.emit("chatMessage", { message, lobbyId });
      }

      function handleReadyButton(event) {
        event.preventDefault();
        const lobbyId = document.getElementById("lobbyId").textContent;
        socket.emit("ready", { lobbyId });
      }

      function handleUnreadyButton(event) {
        event.preventDefault();
        const lobbyId = document.getElementById("lobbyId").textContent;
        socket.emit("unready", { lobbyId });
      }

      function handleStartButton(event) {
        event.preventDefault();
        const lobbyId = document.getElementById("lobbyId").textContent;
        socket.emit("inProgress", { lobbyId });
      }

      function promptLobbyPassword(lobby) {
        const password = prompt(
          "This lobby is password-protected. Please enter the password:"
        );
        if (password !== lobby.password) { 
          promptLobbyPassword(lobby);
        } 
      }

      document
        .getElementById("ready")
        .addEventListener("click", handleReadyButton);
        document
        .getElementById("games")
        .addEventListener("change", handleGameChange);
      document
        .getElementById("unready")
        .addEventListener("click", handleUnreadyButton);
      document
        .getElementById("chatForm")
        .addEventListener("submit", handleChatFormSubmit);
      document
        .getElementById("start")
        .addEventListener("click", handleStartButton);

      socket.on("lobbyJoined", (lobby) => {
        const lobbyIdElement = document.getElementById("lobbyId");
        lobbyIdElement.textContent = lobby.id;
        updatePlayerList(lobby.players);
        updateChatMessages(lobby.chatHistory);
        let lobbyGameValue = document.getElementById('games');
        lobbyGameValue.value = lobby.game;
      });

      socket.on("lobbyUpdated", (lobby) => {
        updatePlayerList(lobby.players);
      });

      socket.on("message", (data) => {
        updateChatMessages(data.messages);
      });

      socket.on("playerReady", (lobby) => {
        updatePlayerList(lobby.players);
      });

      socket.on("playerUnready", (data) => {
        updatePlayerList(data.lobby.players);
        let startButton = document.getElementById("start");
        startButton.disabled = !data.enabled;
      });

      socket.on("enableStartButton", (data) => {
        let startButton = document.getElementById("start");
        startButton.disabled = !data.enabled;
      });

      socket.on("enableGameComboBox", (data) => {
        console.log('kek');
        let gameComboBox = document.getElementById("games");
        gameComboBox.disabled = !data.enabled;
      });

      socket.on("gameStarted", (data) => {
        const lobbyId = data.lobbyId;
        window.location.href = `/lobbies/${lobbyId}/game`;
      });

      socket.on("gameUpdated", (data) => {
        console.log('test');
        let lobbyGameValue = document.getElementById('games');
        lobbyGameValue.value = data.game;
      })

      socket.on("passwordNeeded", (data) => {
        const lobby = data.lobby;
        if (lobby.passwordProtected) {
          promptLobbyPassword(lobby);
        }
      });

      socket.on("connect", () => {
        console.log("Connected to websocket server");

        const lobbyId = window.location.pathname.split("/").pop();
        socket.emit("join", { lobbyId });
      });

      socket.on("disconnect", () => {
        console.log("Disconnected from websocket server");
      });
    </script>
  </body>
</html>
