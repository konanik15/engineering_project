<!DOCTYPE html>
<html>
  <head>
    <title>Main Menu</title>
    <style>
      .disabled-link {
        pointer-events: none; /* Disable mouse events on the link */
        color: gray; /* Optionally, change the color of the link to indicate it's disabled */
        text-decoration: none; /* Optionally, remove underline from the link */
      }
    </style>
  </head>
  <body>
    <h1>Main Menu</h1>
    <div id="lobbyList">
      <h2>Lobbies:</h2>
      <ul id="lobbies"></ul>
    </div>
    <div id="createLobby">
      <h2>Create Lobby:</h2>
      <form id="createLobbyForm">
        <input
          type="text"
          id="lobbyNameInput"
          placeholder="Lobby Name"
          required
        />
        <input type="text" id="lobbyPasswordInput" placeholder="Password" />
        <button type="submit">Create</button>
        <br />
        <label for="cars">Choose the game:</label>
        <select name="games" id="games">
          <option value="wojna">Wojna</option>
          <option value="makao">Makao</option>
          <option value="duren">Duren</option>
          <option value="poker">Poker</option>
        </select>
      </form>
    </div>
    <script src="http://localhost:10100/auth/js/keycloak.js"></script>
    <script>
      if (localStorage.getItem("token") === null) {
        const keycloak = new Keycloak({
          url: "http://localhost:10100/auth",
          realm: "cardz",
          clientId: "account-console",
        });

        keycloak
          .init({
            onLoad: "login-required",
            pkceMethod: "S256",
          })
          .then((authenticated) => {
            const token = keycloak.token;
            localStorage.setItem("token", token);
            console.log("Token saved to localStorage:", token);
          })
          .catch((error) => {
            console.error("Failed to initialize Keycloak:", error);
          });
      }
    </script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
      const socket = io();

      function updateLobbyList(lobbies) {
        const lobbyList = document.getElementById("lobbies");
        lobbyList.innerHTML = "";
        lobbies.forEach((lobby) => {
          const li = document.createElement("li");
          const link = document.createElement("a");
          link.href = `/lobbies/${lobby.id}`;
          const inProgress = lobby.inProgress ? "in progress" : "waiting";
          const isPrivate = lobby.passwordProtected ? "private" : "public";
          link.textContent =
            "[" +
            isPrivate +
            "] " +
            "[" +
            inProgress +
            "] " +
            lobby.name +
            "; game: " +
            lobby.game +
            " [" +
            lobby.players.length +
            " / " +
            lobby.maxPlayers +
            "]";

          if (lobby.players.length === lobby.maxPlayers || lobby.inProgress) {
            link.classList.add("disabled-link");
          }

          if (lobby.passwordProtected) {
            link.addEventListener("click", () => {
              event.preventDefault();
              askForPassword(lobby);
            });
          } else {
            link.addEventListener("click", () => {
              event.preventDefault();
              joinLobby(lobby.id);
            });
          }
          li.appendChild(link);
          lobbyList.appendChild(li);
        });
      }

      function askForPassword(lobby) {
        const storedPassword = getCookie(`lobbyPassword_${lobby.id}`);

        if (storedPassword) {
          console.log("Stored password found:", storedPassword);
          let password = storedPassword;
          socket.emit("validatePassword", {
            lobbyId: lobby.id,
            password,
          });
          socket.once("passwordValidationResult", (data) => {
            if (data.isValid) {
              console.log("Password is valid");
              redirectToLobby(lobby.id);
              //joinLobby(lobby.id);
            }
          });
        } else {
          const passwordPrompt = prompt(
            `Enter the password for lobby "${lobby.name}"`
          );
          if (passwordPrompt) {
            password = passwordPrompt;
            socket.emit("validatePassword", {
              lobbyId: lobby.id,
              password,
            });

            socket.once("passwordValidationResult", (data) => {
              if (data.isValid) {
                storePassword(lobby.id, password);
                redirectToLobby(lobby.id);
                //joinLobby(lobby.id);
              } else {
                alert("Invalid password. Please try again.");
              }
            });
          }
        }
      }

      function storePassword(lobbyId, password) {
        const encodedPassword = encodeURIComponent(password);
        const expirationDate = getCookieExpiration();
        const cookieName = `lobbyPassword_${lobbyId}`;
        const cookieValue = `${cookieName}=${encodedPassword}; expires=${expirationDate}; path=/`;
        document.cookie = cookieValue;
      }

      function getCookieExpiration() {
        const expirationDate = new Date();
        expirationDate.setDate(expirationDate.getDate() + 1);
        return expirationDate.toUTCString();
      }

      function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) {
          return parts.pop().split(";").shift();
        }
      }
      function fetchLobbyList() {
        fetch("/api/lobbies", {
          headers: {
            Authorization: `Bearer ${localStorage.getItem("token")}`,
          },
        })
          .then((response) => response.json())
          .then((lobbies) => {
            updateLobbyList(lobbies);
          })
          .catch((error) => {
            console.error("Failed to fetch lobby list:", error);
          });
      }

      function redirectToLobby(lobbyId) {
        const token = localStorage.getItem("token");
        const queryParams = new URLSearchParams({
          lobbyId: lobbyId,
        });
        window.location.href = `/lobby.html?${queryParams.toString()}`;
      }


      // function joinLobby(lobbyId) {
      //   const token = localStorage.getItem("token");
      //   fetch(`/lobbies/${lobbyId}`, {
      //     headers: {
      //       Authorization: `Bearer ${token}`,
      //     },
      //   })
      //     .then((response) => {
      //       if (response.ok) {
      //         response.json().then((lobby) => {
      //           redirectToLobby(lobby);
      //         });
      //       } else {
      //         console.error("Failed to join lobby:", response.statusText);
      //       }
      //     })
      //     .catch((error) => {
      //       console.error("Failed to join lobby:", error);
      //     });
      // }
      function handleCreateLobbyFormSubmit(event) {
        event.preventDefault();
        const lobbyNameInput = document.getElementById("lobbyNameInput");
        const lobbyGameInput = document.getElementById("games");
        const lobbyPasswordInput =
          document.getElementById("lobbyPasswordInput");
        const name = lobbyNameInput.value;
        const game = lobbyGameInput.value;
        const password = lobbyPasswordInput.value;
        lobbyNameInput.value = "";
        lobbyPasswordInput.value = "";
        lobbyGameInput.value = "wojna";
        fetch("/api/lobbies", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${localStorage.getItem("token")}`,
          },
          body: JSON.stringify({ name, game, password }),
        })
          .then((response) => response.json())
          .then((data) => {
            console.log(data);
            const { message, lobbyId } = data;
            if (message === "Lobby created successfully") {
              storePassword(lobbyId, password);
              redirectToLobby(lobbyId);
              //joinLobby(lobbyId);
            } else {
              console.error("Failed to create lobby:", message);
            }
          })
          .catch((error) => {
            console.error("Failed to create lobby:", error);
          });
      }

      document
        .getElementById("createLobbyForm")
        .addEventListener("submit", handleCreateLobbyFormSubmit);

      socket.on("mainMenuLobbiesUpdated", (lobbyList) => {
        updateLobbyList(lobbyList);
      });

      fetchLobbyList();

      socket.on("connect", () => {
        console.log("Connected to websocket server");
      });

      socket.on("disconnect", () => {
        console.log("Disconnected from websocket server");
      });
    </script>
  </body>
</html>
