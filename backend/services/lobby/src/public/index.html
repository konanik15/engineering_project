<!DOCTYPE html>
<html>
<head>
  <title>Main Menu</title>
  <style>
    .disabled-link {
      pointer-events: none; /* Disable mouse events on the link */
      color: gray; /* Optionally, change the color of the link to indicate it's disabled */
      text-decoration: none; /* Optionally, remove underline from the link */
  }
  </style>
</head>
<body>
  <h1>Main Menu</h1>
  <div id="lobbyList">
    <h2>Lobbies:</h2>
    <ul id="lobbies"></ul>
  </div>
  <div id="createLobby">
    <h2>Create Lobby:</h2>
    <form id="createLobbyForm">
      <input type="text" id="lobbyNameInput" placeholder="Lobby Name" required />
      <button type="submit">Create</button>
      <br>
      <label for="cars">Choose the game:</label>
      <select name="games" id="games">
        <option value="wojna">Wojna</option>
        <option value="makao">Makao</option>
        <option value="duren">Duren</option>
        <option value="poker">Poker</option>
      </select>
    </form>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();

    function updateLobbyList(lobbies) {
      const lobbyList = document.getElementById('lobbies');
      lobbyList.innerHTML = '';
      lobbies.forEach((lobby) => {
        const li = document.createElement('li');
        const link = document.createElement('a');
        link.href = `/lobbies/${lobby.id}`;
        const inProgress = lobby.inProgress === true ? "in progress" : "waiting";
        link.textContent = "[" + inProgress + "] " + lobby.name + "; game: " + lobby.game + " [" + lobby.players.length + " / " + lobby.maxPlayers + "]";
        if(lobby.players.length === lobby.maxPlayers || lobby.inProgress){
          link.classList.add('disabled-link');
        }
        li.appendChild(link);
        lobbyList.appendChild(li);
      });
    }

    function fetchLobbyList() {
      console.log('test123');
      fetch('/api/lobbies')
        .then((response) => response.json())
        .then((lobbies) => {
          updateLobbyList(lobbies);
        })
        .catch((error) => {
          console.error('Failed to fetch lobby list:', error);
        });
    }

    function handleCreateLobbyFormSubmit(event) {
      event.preventDefault();
      const lobbyNameInput = document.getElementById('lobbyNameInput');
      const lobbyGameInput = document.getElementById('games');
      const name = lobbyNameInput.value;
      const game = lobbyGameInput.value;
      lobbyNameInput.value = '';
      fetch('/api/lobbies', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ name, game })
      })
        .then((response) => response.json())
        .then((data) => {
          console.log(data);
          const { message, lobbyId } = data;
          if (message === 'Lobby created successfully') {
            window.location.href = `/lobbies/${lobbyId}`;
            
          } else {
            console.error('Failed to create lobby:', message);
          }
        })
        .catch((error) => {
          console.error('Failed to create lobby:', error);
        });
    }

    document.getElementById('createLobbyForm').addEventListener('submit', handleCreateLobbyFormSubmit);

    socket.on('mainMenuLobbiesUpdated', (lobbyList) => {
      updateLobbyList(lobbyList);
    });

    fetchLobbyList();

    socket.on('connect', () => {
      console.log('Connected to websocket server');
    });

    socket.on('disconnect', () => {
      console.log('Disconnected from websocket server');
    });
  </script>
</body>
</html>